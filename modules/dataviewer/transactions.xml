<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<ROOT>
	<param key=":institution_number">	
	</param>
	<param key=":client_number">	
	</param>
	<param key=":file_number">	
	</param>
	<param key=":transaction_status" value="008">	
	</param>
	<param key=":currency" value="978">	
	</param>
	<param key=":start_date" value="20220901">	
	</param>
	<param key=":end_date" value="20290101">	
	</param>
	<query name="BATCH_INPUT">
		<sql>
			select * from int_batch_capture where institution_number = :institution_number and client_number = ':client_number' and transaction_status = ':transaction_status' order by record_date desc;
		</sql>
		<TransmittedConditionColumns>
			institution_number,summary_settlement
		</TransmittedConditionColumns>
	</query>
	<query name="BATCH_ITEMS" parent="BATCH_INPUT">
		<sql>
			select * from int_batch_capture where institution_number = :institution_number order by record_date desc;
		</sql>
	</query>
	
	<query name="TRANSACTIONS">
		<sql>
			SELECT
			trans.merchant_id,
			trans.acct_number,
			trans.card_organization,
			trans.transaction_slip,
			trans.transaction_date,
			trans.gross_amount,
			charges.charges,
			trans.transaction_currency,
			trans.summary_transaction_slip,
			trans.card_number,
			trans.terminal_id,
			trans.transaction_category,
			trans.transaction_class,
			trans.transaction_type,
			trans.transaction_status,
			trans.area_of_action,
			trans.service_type,
			trans.charge_type,
			trans.sale_channel,
			trans.retrieval_reference,
			trans.acquirer_reference
			FROM (
			SELECT
				T.institution_number,
				summ.client_number,
				summ.acct_number,
				 ccd.our_reference as merchant_id,
				 (bcb.index_field || ' - ' || bcb.card_brand) as card_brand,
				(bco.index_field || ' - ' || bco.card_organization) as card_organization, -- digits 123 from AUTHORIZED_BY
				T.transaction_date as transaction_date,
				T.transaction_slip as transaction_slip,
				summ.transaction_slip as summary_transaction_slip,
				  t.account_amount_gr * decode(t."TRANSACTION_TYPE", '005',1,-1) as gross_amount,
				(bc.iso_code || ' - ' || bc.name) as transaction_currency,
				(bc1.iso_code || ' - ' || bc1.name) as settlement_currency,
				bw3_mask_card_no.DISGUISE_CARD_NO( t.card_number, NULL, NULL, NULL ) card_number, -- disguide card number

				(cdl.location || ' - ' || cdl.pos_region || ' - ' || cdl.pos_city) as location,
				(btc.index_field || ' - ' || btc.transaction_category) as transaction_category,
				(btc1.index_field || ' - ' || btc1.transaction_class) as transaction_class,
				(btt.index_field || ' - ' || btt.transaction_type) as transaction_type,
				(aoa.index_field || ' - ' || aoa.area_of_action) as area_of_action, -- digits 456 from AUTHORIZED_BY
				(bst.index_field || ' - ' || bst.service_type) as service_type, -- digits 789 from AUTHORIZED_BY
				(bs.index_field || ' - ' || bs.service_id) as service_id, -- digits 101112 from AUTHORIZED_BY

				t.rate_fx_tran_settl as rate_fx,
				(bts.index_field || ' - ' || bts.transaction_status) as transaction_status,
				(bct.index_field || ' - ' || bct.charge_type) as charge_type,
				(bcm.index_field || ' - ' || bcm.capture_method) as sale_channel,
				summ.retrieval_reference,
				t.acquirer_reference,
				t.terminal_id,
				T.summary_settlement as summary_number,
				t.rate_fx_tran_settl as exchange_rate
			FROM INT_TRANSACTIONS T
				left join INT_TRANSACTIONS summ on summ.INSTITUTION_NUMBER = T.INSTITUTION_NUMBER
				left join bwt_transaction_status bts on bts.index_field = T.transaction_status and bts.institution_number = t.institution_number and bts.language = 'USA'
				left join bwt_transaction_category btc on btc.index_field = T.transaction_category and btc.institution_number = t.institution_number and btc.language = 'USA'
				left join bwt_transaction_class btc1 on btc1.index_field = T.transaction_class and btc1.institution_number = t.institution_number and btc1.language = 'USA'
				left join BWT_SIGN_OPERATORS bso on bso.index_field = T.dr_cr_indicator and bso.institution_number = t.institution_number and bso.language = 'USA'
				left join BWT_TRANSACTION_TYPE btt on btt.index_field = T.transaction_type and btt.institution_number = t.institution_number and btt.language = 'USA'
				left join BWT_CARD_BRAND bcb on bcb.index_field = T.card_brand and bcb.institution_number = t.institution_number and bcb.language = 'USA'
				left join BWT_CARD_ORGANIZATION bco on bco.index_field = SUBSTR(t.AUTHORIZED_BY,0,3) and bco.institution_number = t.institution_number and bco.language = 'USA'
				left join cht_area_of_action  aoa on aoa.index_field = SUBSTR(t.AUTHORIZED_BY,3,3) and aoa.institution_number = t.institution_number and aoa.language = 'USA'
				left join bwt_service_type  bst on bst.index_field = SUBSTR(t.AUTHORIZED_BY,6,3) and bst.institution_number = t.institution_number and bst.language = 'USA'
				left join bwt_services  bs on bs.index_field = SUBSTR(t.AUTHORIZED_BY,9,3) and bs.institution_number = t.institution_number and bs.language = 'USA'
				left join bwt_currency bc on bc.iso_code = t.tran_currency and bc.institution_number = t.institution_number and bc.language = 'USA'
				left join bwt_currency bc1 on bc1.iso_code = t.settlement_currency and bc1.institution_number = t.institution_number and bc1.language = 'USA'
				left join cis_device_link cdl on cdl.terminal_id = T.terminal_id and cdl.institution_number = t.institution_number
				left join int_addendum_charges charge on charge.institution_number = t.institution_number AND charge.charge_transaction_slip = t.transaction_slip
				left JOIN bwt_charge_type bct ON bct.index_field = charge.charge_type and bct.institution_number = charge.institution_number and bct.language = 'USA'
				left JOIN bwt_capture_method bcm ON bcm.index_field = T.capture_method and bcm.institution_number = t.institution_number and bcm.language = 'USA'
				left JOIN CIS_CLIENT_DETAILS ccd ON ccd.institution_number = summ.institution_number and ccd.client_number = summ.client_number
				left join cas_client_account cca on cca.institution_number = t.institution_number and cca.client_number = t.client_number and cca.acct_number = t.acct_number and cca.acct_currency = t.acct_currency
			WHERE
				T.INSTITUTION_NUMBER = ':institution_number'
				AND summ.CLIENT_NUMBER = ':client_number'
				AND summ.ACCT_CURRENCY = ':currency'
				AND summ.TRANSACTION_DATE between ':start_date' and ':end_date'
				AND summ.TRANSACTION_CLASS = '012'
				AND summ.TRANSACTION_CATEGORY = '016'
				AND T.SOURCE_SETTLEMENT = summ.TRANSACTION_SLIP
				AND T.CLIENT_NUMBER not in (':client_number')
				AND T.TRANSACTION_CLASS = '002'
				AND T.TRANSACTION_CATEGORY = '001'
				AND T.TRANSACTION_STATUS in ('002', '004' ,'009','007')
				AND T.TRANSACTION_TYPE != '006'
				AND T.REVERSAL_FLAG = '000'
			order by T.transaction_date desc, T.transaction_slip asc) trans
			INNER JOIN
			(select
			 C.institution_number, C.transaction_slip, LISTAGG(bct.index_field || ' - ' || bct.charge_type || ' : ' || C.transaction_amount, ' ,') WITHIN GROUP (ORDER BY transaction_slip) AS charges
			from int_addendum_charges C
			 left join BWT_TRANSACTION_TYPE btt on btt.index_field = C.transaction_type and btt.institution_number = C.institution_number and btt.language = 'USA'
			 left JOIN bwt_charge_type bct ON bct.index_field = C.charge_type and bct.institution_number = C.institution_number and bct.language = 'USA'
			  where C.institution_number = ':institution_number'
			  group by C.institution_number, C.transaction_slip
			 )
			 charges ON charges.institution_number = trans.institution_number and charges.transaction_slip = trans.transaction_slip;
		</sql>
		<TransmittedConditionColumns>
			institution_number,file_number,transaction_slip
		</TransmittedConditionColumns>
	</query>
	
	<query name="CHARGES" parent="TRANSACTIONS">
		<sql>
		select
		 T.transaction_amount,
		 (btt.index_field || ' - ' || btt.transaction_type) as transaction_type,
		 (bct.index_field || ' - ' || bct.charge_type) as charge_type,
		 T.record_date,
		 T.billing_acct_number as acct_number,
		 T.charge_institution
		 from int_addendum_charges T
		 left join BWT_TRANSACTION_TYPE btt on btt.index_field = T.transaction_type and btt.institution_number = t.institution_number and btt.language = 'USA'
		 left JOIN bwt_charge_type bct ON bct.index_field = t.charge_type and bct.institution_number = t.institution_number and bct.language = 'USA'
		where
		T.institution_number = :institution_number and T.transaction_slip in (select distinct transaction_slip from int_transactions where institution_number = ':institution_number' and acct_currency in (':currency'));
		</sql>
	</query>
	
	<query name="GL_TRANS" parent="TRANSACTIONS">
		<sql>
		select
       gl.record_date,
       transaction_source,
       file_number,
       transaction_slip,
       ph.process_id||','||SUBSTR(ACQUIRER_REFERENCE,7,3) AS PHASE_ID,
       MERCHANT_NAME as instr_description ,MERCHANT_CITY as rule_id,
       INWARD_FEE_NUMBER as gl_acct_id,
       nvl(ch1.principal_cr,'(deleted)') as account_no,
       case when (gl.transaction_type = '901') then 'credit ->   '|| nvl(ch1.gl_account_name,'(deleted)')
      else
      'debit  ->   '||ch1.gl_account_name
      end as action_on_gl_acct,
       OUTWARD_FEE_NUMBER  as "counter GL ID",
       ACCOUNT_ADDRESS as "counter GL acct nr",
       nvl(ch2.gl_account_name,'(deleted)') as "counter GL acct name",
  gl.TRANSACTION_TYPE,
  gl.tran_amount_gr,
  gl.tran_currency,
  gl.local_amount_gr * decode(gl.transaction_type,'901',1,-1) as local_amount_gr ,
  gl.account_amount_gr,
  gl.local_currency,
  gl.acct_currency,RATE_FX_LOCAL_ACCT,
  gl.settlement_currency, SETTLEMENT_AMOUNT_GR,
  DR_CR_INDICATOR, substr(acquirer_reference,10,3) as transaction_class,
  substr(acquirer_reference,13,3)as transaction_category,
  substr(acquirer_reference,4,3) as synthetic_extension,
  substr(acquirer_reference,1,3) as gl_Acct_type_id,
  SUBSTR(ACQUIRER_REFERENCE,16,3)as instruction_sequence_number, gl.audit_trail
from bw3.int_gl_transactions gl, bw3.cbr_chart_of_accounts ch1, bw3.cbr_chart_of_accounts ch2,bw3.bwt_PROCESS_ID ph
where
gl.institution_number in (':institution_number') and
ch2.institution_number(+)=GL.institution_number and
inward_fee_number = ch1.record_id_number(+) and
outward_fee_number = ch2.record_id_number(+)
and gl.institution_number = ch1.institution_number(+)
and SUBSTR(ACQUIRER_REFERENCE,7,3)=ph.index_field(+) and gl.institution_number=ph.institution_number(+) and ph.language(+)='USA'  --processing phase
order by gl.transaction_slip,transaction_source,file_number,ph.process_id,transaction_slip , merchant_city,TRANSACTION_TYPE,SUBSTR(ACQUIRER_REFERENCE,16,3), merchant_name,local_Amount_gr                                  ;--GL_ACCT_ID, ACTION_ON_GL_ACCT
</sql>
	</query>
	
	<query name="chargebacks">
		<sql>
			select cbk.*
from int_transactions cbk
where
	cbk.institution_number = ':institution_number'
	and cbk.transaction_category = '002'
	and cbk.transaction_class = '002'
	AND cbk.settlement_CURRENCY =  ':currency'
	AND cbk.SETTLEMENT_DATE between ':start_date' AND ':end_date'
order by cbk.transaction_date desc, cbk.transaction_slip asc;
		</sql>
	</query>
	
		<query name="FEE">
		<sql>
		SELECT *
FROM INT_TRANSACTIONS fee
WHERE
	fee.INSTITUTION_NUMBER = ':institution_number'
	AND fee.CLIENT_NUMBER = ':client_number'
	AND fee.ACCT_CURRENCY =  ':currency'
	AND fee.TRANSACTION_DATE between ':start_date' AND ':end_date'
	AND fee.REVERSAL_FLAG = '000'
	AND fee.TRANSACTION_STATUS in ('002', '004' ,'009','007')
	AND fee.TRANSACTION_CLASS in ('002')
	AND fee.TRANSACTION_CATEGORY in ('007')
order by fee.transaction_date desc, fee.transaction_slip asc;
		</sql>
	</query>
	
	<query name="after inward and settlement process">
		<sql>
			select distinct a.file_number, a.transaction_slip, a.account_address, a.transaction_class, a.transaction_category,
			b.acct_number, b.service_contract_id, b.account_type_id, b.settlement_number,
			c.begin_balance, c.current_balance,c.dr_balance_cash,c.dr_balance_retail,c.dr_balance_interest,c.dr_balance_charges, c.cr_balance_payments, c.cr_balance_refunds, c.cr_balance_interest
			from INT_TRANSACTIONS a
			left outer join CAS_CLIENT_ACCOUNT b on b.client_number = a.client_number and b.institution_number = a.institution_number
			left outer join CAS_CYCLE_BOOK_BALANCE c on c.acct_number like '50641653%' and c.institution_number = a.institution_number -- put actual account number
			where a.file_number = ':file_number'-- insert actual file number
			and a.institution_number = ':institution_number'
			-- and a.transaction_class = 001
			-- and a.transaction_category = '015' 
			-- and b.service_contract_id = '497'
			-- and account_type_id = '170'
			and a.client_number = ':client_number' -- put acctual client_number
			-- and a.transaction_slip = '90451362013'
			order by a.transaction_class ;
		</sql>
	</query>
	<query name="CHECKING DB/CR amount match">
		<sql>
			SELECT t.*, cr_amount - dr_amount AS difference
FROM
    (
    SELECT file_number, --transaction_source,
           card_number, g.acct_currency,
           SUBSTR(g.acquirer_reference, 1,3) AS gl_account_type_id,
           MAX(ga.type_id) AS gl_type,
           SUBSTR(g.acquirer_reference, 4,3) AS synth_extension,
           SUM(DECODE(g.dr_cr_indicator,'002',account_amount_gr,0)) AS dr_amount,
           SUM(DECODE(g.dr_cr_indicator,'001',account_amount_gr,0)) AS cr_amount ,
           count(*) as gl_count
      FROM bw3.int_gl_transactions g
      LEFT JOIN bw3.bwt_account_type_id ga ON ga.institution_number = g.institution_number
                                          AND ga.index_field = SUBSTR(g.acquirer_reference, 1,3)
                                          AND ga.language = 'USA'
     WHERE g.institution_number = ':institution_number'
       AND g.file_number in (':file_number')
     GROUP BY g.file_number, --g.transaction_source,
              g.card_number, g.acct_currency,
              SUBSTR(g.acquirer_reference, 1,3),
              SUBSTR(g.acquirer_reference, 4,3)
    ) t
 ORDER BY 1,2,3;
		</sql>
	</query>
	

</ROOT>
